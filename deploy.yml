---
- hosts: all
  user: ansible
  become: true
  tasks:
    - name: Adding glo-ar-{{ansible_hostname}} to AllowGroups in SSHD
      replace:
             dest: /etc/ssh/sshd_config
             regexp: 'glo-ar-iahdvltpl001'
             replace: 'glo-ar-{{ansible_hostname}}'
             backup: yes

    - name: Updating /etc/hostname file
      replace:
             dest: /etc/hostname
             regexp: '{{ansible_hostname}}'
             replace: '{{inventory_hostname}}'


    - name: Creating new LVM Volume Group
      lvg:
             vg: vg01
             pvs: /dev/sdb
             state: present
    - name: Creating new LVM Logical Volume
      lvol:
             vg: vg01
             lv: lvlocal
             size: 100%FREE

    - name: Creating a xfs filesystem for local disk
      filesystem:
             fstype: xfs
             dev: /dev/mapper/vg01-lvlocal

    - name: Creating local directory
      file:
             path: /local
             state: directory
             mode: 0755

    - name: Mounting local disk
      mount:
             path: /local
             src: /dev/mapper/vg01-lvlocal
             fstype: xfs
             state: present

    - name: Registering server to spacewalk
      rhn_register:
             state: present
             activationkey: 1-03iahd-cent07-vm-key
             server_url: http://spacewalk.logistics.corp/XMLRPC
             sslcacert: /usr/share/rhn/RHN-ORG-TRUSTED-SSL-CERT
             username: casill-adm
             password: marjie1453
            
    - name: Install package software
      yum: 
             name: python2-pip
             state: latest
                        
    - name:  Upgrading python-pip
      shell: /bin/bash -c "pip install --upgrade pip"

    - name: Installing pexpect
      shell: /bin/bash -c "pip install pexpect"    

    - name: Updating all packages
      yum:
             name: '*'
             state: latest

    - name: Discovering Realm
      shell: /bin/bash -c "realm discover LOGISTICS.CORP"

    - name: Joining system to AD
      expect:
             command: /bin/bash -c "/usr/sbin/realm join LOGISTICS.CORP --user=casill-adm"
             responses:
                 Password*: "r00t@2015"
